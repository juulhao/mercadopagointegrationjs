<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-        // Configura√ß√£o da API - Porta correta do servidor
        const API_BASE_URL = 'http://localhost:3333'; // Porta atual do servidor>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exemplo - Token do Cart√£o</title>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #00a650; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #008a43; }
        .status { margin-top: 20px; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <h1>üí≥ Gerar Token do Cart√£o</h1>
    
    <div class="status info">
        <strong>Dados de Teste:</strong><br>
        Cart√£o: 4509 9535 6623 3704 (Visa)<br>
        Nome: APRO<br>
        Validade: 11/25<br>
        CVV: 123<br>
        CPF: 12345678909
    </div>

    <!-- Configura√ß√£o de Redirecionamento -->
    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px;">
        <h3>üîÑ Configura√ß√£o de Redirecionamento</h3>
        <div class="form-group">
            <label>URL Sucesso:</label>
            <input type="text" id="successUrl" value="./pagamento-sucesso.html" style="margin-bottom: 5px;">
        </div>
        <div class="form-group">
            <label>URL Erro:</label>
            <input type="text" id="failureUrl" value="./pagamento-erro.html" style="margin-bottom: 5px;">
        </div>
        <div class="form-group">
            <label>URL Pendente:</label>
            <input type="text" id="pendingUrl" value="./pagamento-pendente.html">
        </div>
        <small>‚ÑπÔ∏è Para teste, ser√° mostrado apenas o link. Em produ√ß√£o, descomente a linha de redirecionamento no c√≥digo.</small>
    </div>
    
    <form id="card-form">
        <div class="form-group">
            <label>N√∫mero do Cart√£o:</label>
            <input type="text" id="cardNumber" placeholder="4509 9535 6623 3704" data-checkout="cardNumber" value="4509953566233704">
        </div>
        
        <div class="form-group">
            <label>Nome no Cart√£o:</label>
            <input type="text" id="cardholderName" placeholder="APRO" data-checkout="cardholderName" value="APRO">
        </div>
        
        <div class="form-group">
            <label>M√™s de Expira√ß√£o:</label>
            <input type="text" id="cardExpirationMonth" placeholder="11" data-checkout="cardExpirationMonth" value="11">
        </div>
        
        <div class="form-group">
            <label>Ano de Expira√ß√£o:</label>
            <input type="text" id="cardExpirationYear" placeholder="25" data-checkout="cardExpirationYear" value="25">
        </div>
        
        <div class="form-group">
            <label>C√≥digo de Seguran√ßa:</label>
            <input type="text" id="securityCode" placeholder="123" data-checkout="securityCode" value="123">
        </div>
        
        <div class="form-group">
            <label>CPF do Portador:</label>
            <input type="text" id="docNumber" placeholder="12345678909" data-checkout="docNumber" value="12345678909">
        </div>
        
        <button type="submit">üöÄ Gerar Token e Pagar</button>
        <button type="button" onclick="testConnection()" style="margin-left: 10px; background: #007bff;">üîß Testar Conex√£o</button>
    </form>

    <div id="status"></div>

    <script>
        // Configura√ß√£o da API - Altere a porta conforme necess√°rio
        const API_BASE_URL = 'http://localhost:3333'; // Porta atual do servidor
        
        // Inicializar o MercadoPago com sua chave p√∫blica
        const mp = new MercadoPago('TEST-8b791b84-1d05-460d-aee5-f89c3053f21b', {
            locale: 'pt-BR'
        });

        // Fun√ß√£o para exibir status
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // Fun√ß√£o para gerar o token
        async function createCardToken() {
            showStatus('üîÑ Gerando token do cart√£o...', 'info');
            
            const cardData = {
                cardNumber: document.getElementById('cardNumber').value.replace(/\s/g, ''),
                cardholderName: document.getElementById('cardholderName').value,
                cardExpirationMonth: document.getElementById('cardExpirationMonth').value,
                cardExpirationYear: document.getElementById('cardExpirationYear').value,
                securityCode: document.getElementById('securityCode').value,
                identificationType: 'CPF',
                identificationNumber: document.getElementById('docNumber').value,
            };

            console.log('Dados do cart√£o:', cardData);

            try {
                const token = await mp.createCardToken(cardData);
                console.log('Token gerado:', token);
                showStatus(`‚úÖ Token gerado com sucesso: ${token.id}`, 'success');
                return token.id;
            } catch (error) {
                console.error('Erro ao gerar token:', error);
                showStatus(`‚ùå Erro ao gerar token: ${error.message}`, 'error');
                return null;
            }
        }

        // Fun√ß√£o para obter URLs de redirecionamento configuradas
        function getRedirectUrls() {
            return {
                success: document.getElementById('successUrl').value || './pagamento-sucesso.html',
                failure: document.getElementById('failureUrl').value || './pagamento-erro.html',
                pending: document.getElementById('pendingUrl').value || './pagamento-pendente.html'
            };
        }

        // Fun√ß√£o para redirecionar baseado no status do pagamento
        function redirectAfterPayment(paymentStatus, paymentData) {
            const redirectUrls = getRedirectUrls();
            let redirectUrl = null;
            let message = '';
            
            // Determinar URL de redirecionamento baseado no status
            switch (paymentStatus) {
                case 'approved':
                    redirectUrl = redirectUrls.success;
                    message = '‚úÖ Pagamento aprovado! Redirecionando...';
                    break;
                case 'pending':
                    redirectUrl = redirectUrls.pending;
                    message = '‚è≥ Pagamento pendente! Redirecionando...';
                    break;
                case 'rejected':
                case 'cancelled':
                    redirectUrl = redirectUrls.failure;
                    message = '‚ùå Pagamento rejeitado! Redirecionando...';
                    break;
                default:
                    redirectUrl = redirectUrls.failure;
                    message = '‚ö†Ô∏è Status desconhecido! Redirecionando...';
            }

            // Adicionar par√¢metros √† URL para tracking
            const urlParams = new URLSearchParams({
                payment_id: paymentData.id || 'unknown',
                status: paymentStatus,
                amount: paymentData.transaction_amount || '0',
                timestamp: new Date().toISOString()
            });
            
            const finalUrl = `${redirectUrl}?${urlParams.toString()}`;
            
            showStatus(message, paymentStatus === 'approved' ? 'success' : 'error');
            
            // Aguardar 3 segundos antes do redirecionamento
            setTimeout(() => {
                // Para teste, apenas mostrar onde redirecionaria
                // Em produ√ß√£o, descomente a linha abaixo:
                // window.location.href = finalUrl;
                
                // Para demonstra√ß√£o, mostrar o link de redirecionamento
                showStatus(`
                    ${message}<br>
                    <strong>Redirecionamento:</strong> <a href="${finalUrl}" target="_blank">${finalUrl}</a><br>
                    <button onclick="window.location.href='${finalUrl}'" style="margin-top: 10px; background: #007bff;">
                        üîó Testar Redirecionamento
                    </button><br>
                    <small>‚ÑπÔ∏è Em produ√ß√£o, o usu√°rio seria redirecionado automaticamente.</small>
                `, paymentStatus === 'approved' ? 'success' : 'error');
            }, 3000);
        }

        // Fun√ß√£o para enviar pagamento para seu backend
        async function processPayment(cardToken) {
            showStatus('üîÑ Processando pagamento...', 'info');
            
            const paymentData = {
                amount: 100,
                description: "Pagamento de teste",
                payer_email: "test@test.com",
                card_token: cardToken,
                installments: 1,
                payment_method_id: "visa"
            };

            console.log('Dados do pagamento:', paymentData);

            try {
                const response = await fetch(`${API_BASE_URL}/payment/credit-card`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify(paymentData)
                });

                console.log('Status da resposta:', response.status);
                const result = await response.json();
                console.log('Resultado do pagamento:', result);
                
                if (response.ok && result.id) {
                    const paymentStatus = result.status || 'unknown';
                    showStatus(`‚úÖ Pagamento processado! Status: ${paymentStatus} | ID: ${result.id}`, 'success');
                    
                    // Redirecionar baseado no status do pagamento
                    redirectAfterPayment(paymentStatus, result);
                } else {
                    showStatus(`‚ùå Erro no pagamento: ${result.error}`, 'error');
                    
                    // Redirecionar para p√°gina de erro ap√≥s falha
                    redirectAfterPayment('rejected', { id: 'error', transaction_amount: paymentData.amount });
                }
            } catch (error) {
                console.error('Erro na requisi√ß√£o:', error);
                showStatus(`‚ùå Erro na comunica√ß√£o com o servidor: ${error.message}`, 'error');
                
                // Redirecionar para p√°gina de erro ap√≥s falha de comunica√ß√£o
                redirectAfterPayment('rejected', { id: 'communication_error', transaction_amount: paymentData.amount });
            }
        }

        // Fun√ß√£o para testar conex√£o com MercadoPago
        async function testConnection() {
            showStatus('üîÑ Testando conex√£o com MercadoPago...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/payment/test`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                const result = await response.json();
                console.log('Teste de conex√£o:', result);
                
                if (response.ok && result.success) {
                    showStatus(`‚úÖ Conex√£o com MercadoPago OK! Test Payment ID: ${result.test_payment_id}`, 'success');
                } else {
                    showStatus(`‚ùå Erro na conex√£o: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Erro no teste de conex√£o:', error);
                showStatus(`‚ùå Erro no teste de conex√£o: ${error.message}`, 'error');
            }
        }

        // Event listener do formul√°rio
        document.getElementById('card-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            console.log('üöÄ Iniciando processo de pagamento...');
            const cardToken = await createCardToken();
            
            if (cardToken) {
                console.log('Token gerado com sucesso:', cardToken);
                await processPayment(cardToken);
            }
        });

        // Teste de conectividade ao carregar a p√°gina
        window.addEventListener('load', async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (response.ok) {
                    showStatus('‚úÖ Conectado com o servidor backend!', 'success');
                } else {
                    showStatus('‚ö†Ô∏è Servidor backend respondeu, mas com erro', 'error');
                }
            } catch (error) {
                showStatus('‚ùå N√£o foi poss√≠vel conectar com o servidor backend. Certifique-se de que est√° rodando na porta 3333.', 'error');
            }
        });
    </script>
</body>
</html>
