<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo - Payment Brick PIX e Cart√£o</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .demo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .demo-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .card-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .card-header h2 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .card-header p {
            opacity: 0.9;
        }

        .card-content {
            padding: 20px;
        }

        .product {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .product-emoji {
            font-size: 3rem;
        }

        .product-info h3 {
            color: #333;
            margin-bottom: 5px;
        }

        .product-info p {
            color: #666;
            font-size: 0.9rem;
        }

        .price {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00a650;
            text-align: center;
            margin: 15px 0;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e9ecef;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .features {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .features h2 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .feature {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .feature-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .feature h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .feature p {
            color: #666;
            line-height: 1.6;
        }

        .status {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .status h2 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }

        .logs {
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 20px;
            border-radius: 10px;
            height: 300px;
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .demo-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí≥ Payment Brick Demo</h1>
            <p>PIX e Cart√£o de Cr√©dito com Mercado Pago</p>
        </div>

        <div class="demo-grid">
            <!-- Produto 1: Smartphone -->
            <div class="demo-card">
                <div class="card-header">
                    <h2>üì± Smartphone</h2>
                    <p>Pagamento instant√¢neo</p>
                </div>
                <div class="card-content">
                    <div class="product">
                        <div class="product-emoji">üì±</div>
                        <div class="product-info">
                            <h3>iPhone 15 Pro</h3>
                            <p>256GB, Titanium Blue</p>
                        </div>
                    </div>
                    <div class="price">R$ 1.299,90</div>
                    <button class="btn btn-primary" onclick="buyProduct('smartphone', 1299.90)">
                        üõí Comprar Agora
                    </button>
                    <button class="btn btn-secondary" onclick="openPaymentBrick('smartphone', 1299.90)">
                        üí≥ Payment Brick
                    </button>
                </div>
            </div>

            <!-- Produto 2: Notebook -->
            <div class="demo-card">
                <div class="card-header">
                    <h2>üíª Notebook</h2>
                    <p>Valor alto para testar</p>
                </div>
                <div class="card-content">
                    <div class="product">
                        <div class="product-emoji">üíª</div>
                        <div class="product-info">
                            <h3>MacBook Pro M3</h3>
                            <p>16GB RAM, 512GB SSD</p>
                        </div>
                    </div>
                    <div class="price">R$ 4.599,00</div>
                    <button class="btn btn-primary" onclick="buyProduct('notebook', 4599.00)">
                        üõí Comprar Agora
                    </button>
                    <button class="btn btn-secondary" onclick="openPaymentBrick('notebook', 4599.00)">
                        üí≥ Payment Brick
                    </button>
                </div>
            </div>

            <!-- Produto 3: Fone de Ouvido -->
            <div class="demo-card">
                <div class="card-header">
                    <h2>üéß Fone Premium</h2>
                    <p>Valor baixo para PIX</p>
                </div>
                <div class="card-content">
                    <div class="product">
                        <div class="product-emoji">üéß</div>
                        <div class="product-info">
                            <h3>AirPods Pro 2</h3>
                            <p>Cancelamento de ru√≠do</p>
                        </div>
                    </div>
                    <div class="price">R$ 99,90</div>
                    <button class="btn btn-primary" onclick="buyProduct('fone', 99.90)">
                        üõí Comprar Agora
                    </button>
                    <button class="btn btn-secondary" onclick="openPaymentBrick('fone', 99.90)">
                        üí≥ Payment Brick
                    </button>
                </div>
            </div>
        </div>

        <!-- Features -->
        <div class="features">
            <h2>üöÄ Recursos do Payment Brick</h2>
            <div class="features-grid">
                <div class="feature">
                    <div class="feature-icon">‚ö°</div>
                    <h3>PIX Instant√¢neo</h3>
                    <p>Pagamentos via PIX processados em tempo real com QR Code integrado</p>
                </div>
                <div class="feature">
                    <div class="feature-icon">üí≥</div>
                    <h3>Cart√µes</h3>
                    <p>Aceita todos os cart√µes de cr√©dito e d√©bito com parcelamento</p>
                </div>
                <div class="feature">
                    <div class="feature-icon">üîí</div>
                    <h3>Seguran√ßa</h3>
                    <p>Certifica√ß√£o PCI DSS e tokeniza√ß√£o para m√°xima seguran√ßa</p>
                </div>
                <div class="feature">
                    <div class="feature-icon">üì±</div>
                    <h3>Responsivo</h3>
                    <p>Interface otimizada para desktop, tablet e mobile</p>
                </div>
            </div>
        </div>

        <!-- Status e Logs -->
        <div class="status">
            <h2>üìä Status do Sistema</h2>
            <div class="logs" id="logs">
                <div>üöÄ Sistema iniciado!</div>
                <div>‚úÖ Servidor: http://localhost:3333</div>
                <div>üîë Credenciais: TESTE (sandbox)</div>
                <div>üì° Webhook: Configurado</div>
                <div>üí° Clique em qualquer produto para testar...</div>
            </div>
        </div>
    </div>

    <script>
        // Fun√ß√£o para adicionar logs
        function addLog(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const emoji = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logs.innerHTML += `<div>[${timestamp}] ${emoji} ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }

        // Compra simples (redirecionamento)
        function buyProduct(product, price) {
            addLog(`Iniciando compra: ${product} - R$ ${price.toFixed(2)}`);
            
            const externalReference = 'ORDER-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            fetch('/payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    items: [{
                        title: `Produto: ${product}`,
                        quantity: 1,
                        unit_price: price
                    }],
                    payer: {
                        email: 'test@example.com'
                    },
                    external_reference: externalReference
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.checkout_url) {
                    addLog(`‚úÖ Prefer√™ncia criada: ${data.id}`, 'success');
                    addLog(`üîó Redirecionando para checkout...`);
                    window.open(data.checkout_url, '_blank');
                } else {
                    addLog(`‚ùå Erro: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                addLog(`‚ùå Erro na requisi√ß√£o: ${error.message}`, 'error');
            });
        }

        // Payment Brick (modal)
        function openPaymentBrick(product, price) {
            addLog(`Abrindo Payment Brick: ${product} - R$ ${price.toFixed(2)}`);
            
            // Criar modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; text-align: center;">
                        <h2>üí≥ Payment Brick</h2>
                        <p>${product} - R$ ${price.toFixed(2)}</p>
                        <button onclick="this.closest('div').parentElement.parentElement.remove()" 
                                style="position: absolute; top: 10px; right: 15px; background: none; border: none; color: white; font-size: 24px; cursor: pointer;">√ó</button>
                    </div>
                    <div style="padding: 20px;">
                        <div id="modalPaymentBrick">
                            <div style="text-align: center; padding: 40px;">
                                <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                <p style="margin-top: 15px;">Carregando Payment Brick...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Inicializar Payment Brick no modal
            initPaymentBrickModal(product, price);
        }

        // Inicializar Payment Brick no modal
        async function initPaymentBrickModal(product, price) {
            try {
                addLog('üîÑ Criando prefer√™ncia para Payment Brick...');
                
                const externalReference = 'ORDER-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                
                // Criar prefer√™ncia
                const preference = await fetch('/api/create-preference', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        items: [{
                            title: `Produto: ${product}`,
                            quantity: 1,
                            unit_price: price
                        }],
                        external_reference: externalReference,
                        payer: {
                            email: 'test@example.com'
                        }
                    })
                }).then(response => response.json());
                
                if (!preference.success) {
                    throw new Error(preference.error);
                }
                
                addLog(`‚úÖ Prefer√™ncia criada: ${preference.preference_id}`, 'success');
                addLog(`üîë Public Key: ${preference.public_key.substring(0, 20)}...`);
                
                // Inicializar SDK
                const mp = new MercadoPago(preference.public_key, {
                    locale: 'pt-BR'
                });
                
                const bricksBuilder = mp.bricks();
                
                // Criar Payment Brick com configura√ß√£o espec√≠fica para PIX
                await bricksBuilder.create('payment', 'modalPaymentBrick', {
                    initialization: {
                        amount: price,
                        preferenceId: preference.preference_id,
                    },
                    customization: {
                        paymentMethods: {
                            // Configura√ß√£o espec√≠fica para habilitar PIX
                            bankTransfer: ["pix"],   // PIX especificamente
                            ticket: ["bolbradesco"], // Boleto
                            creditCard: "all",      // Cart√£o de cr√©dito
                            debitCard: "all",       // Cart√£o de d√©bito
                            mercadoPago: "all",     // Carteira digital
                            maxInstallments: 12     // Parcelamento
                        },
                        visual: {
                            style: {
                                theme: 'default'
                            }
                        }
                    },
                    callbacks: {
                        onReady: () => {
                            addLog('‚úÖ Payment Brick carregado!', 'success');
                        },
                        onSubmit: async (formData) => {
                            addLog('üì§ Processando pagamento...');
                            
                            try {
                                const response = await fetch('/api/process-payment', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        ...formData,
                                        transaction_amount: price,
                                        description: `Produto: ${product}`,
                                        external_reference: externalReference
                                    })
                                });
                                
                                const result = await response.json();
                                
                                if (result.success) {
                                    addLog(`‚úÖ Pagamento ${result.status}: ${result.id}`, 'success');
                                    
                                    if (result.status === 'approved') {
                                        addLog('üéâ Pagamento aprovado!', 'success');
                                        setTimeout(() => {
                                            window.location.href = `/success?payment_id=${result.id}`;
                                        }, 2000);
                                    } else if (result.payment_method_id === 'pix' && result.status === 'pending') {
                                        addLog('üì± PIX gerado! Verifique o QR Code.', 'success');
                                    }
                                } else {
                                    addLog(`‚ùå Erro: ${result.error}`, 'error');
                                }
                                
                                return result;
                            } catch (error) {
                                addLog(`‚ùå Erro no pagamento: ${error.message}`, 'error');
                                throw error;
                            }
                        },
                        onError: (error) => {
                            addLog(`‚ùå Erro no Payment Brick: ${error.message}`, 'error');
                        }
                    }
                });
                
            } catch (error) {
                addLog(`‚ùå Erro ao inicializar Payment Brick: ${error.message}`, 'error');
            }
        }

        // Adicionar CSS para anima√ß√£o
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
    
    <!-- Mercado Pago SDK -->
    <script src="https://sdk.mercadopago.com/js/v2"></script>
</body>
</html>
