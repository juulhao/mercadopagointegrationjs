<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento - Payment Brick</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            display: flex;
            flex-wrap: wrap;
        }

        .product-info {
            flex: 1;
            min-width: 300px;
            padding: 30px;
            background: #f8f9fa;
        }

        .payment-section {
            flex: 1;
            min-width: 400px;
            padding: 30px;
        }

        .product-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .product-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .product-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 10px;
        }

        .product-description {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .price {
            font-size: 2rem;
            font-weight: bold;
            color: #00a650;
            text-align: center;
            padding: 15px;
            background: #f0f8f0;
            border-radius: 8px;
        }

        .payment-title {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        #paymentBrick_container {
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .payment-methods {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .payment-method {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #666;
        }

        .payment-method.active {
            border-color: #00a650;
            color: #00a650;
        }

        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .product-info, .payment-section {
                min-width: unset;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõçÔ∏è Loja Eletr√¥nica</h1>
            <p>Pagamento seguro com PIX e Cart√£o</p>
        </div>
        
        <div class="content">
            <div class="product-info">
                <div class="product-card">
                    <div class="product-image">
                        üì±
                    </div>
                    <div class="product-title">Smartphone Premium</div>
                    <div class="product-description">
                        Smartphone de √∫ltima gera√ß√£o com c√¢mera de alta resolu√ß√£o, 
                        processador r√°pido e bateria de longa dura√ß√£o. Ideal para 
                        trabalho e entretenimento.
                    </div>
                    <div class="price">R$ 1.299,90</div>
                </div>
                
                <div class="payment-methods">
                    <div class="payment-method active">
                        üè¶ PIX
                    </div>
                    <div class="payment-method active">
                        üí≥ Cart√£o
                    </div>
                    <div class="payment-method active">
                        üîí Seguro
                    </div>
                </div>
            </div>
            
            <div class="payment-section">
                <h2 class="payment-title">Finalizar Pagamento</h2>
                
                <div id="statusContainer"></div>
                
                <div id="paymentBrick_container">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>Carregando formas de pagamento...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mercado Pago SDK -->
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    
    <script>
        // Configura√ß√£o do produto
        const product = {
            title: "Smartphone Premium",
            description: "Smartphone de √∫ltima gera√ß√£o",
            price: 1299.90,
            quantity: 1
        };

        // Configura√ß√£o do Mercado Pago
        let mp;
        let bricksBuilder;
        let paymentBrickController;

        // Fun√ß√£o para mostrar status
        function showStatus(message, type = 'info') {
            const container = document.getElementById('statusContainer');
            container.innerHTML = `
                <div class="alert alert-${type}">
                    ${message}
                </div>
            `;
            
            // Adicionar bot√£o de atualiza√ß√£o para pagamentos pendentes
            if (type === 'info' || type === 'warning') {
                const refreshButton = document.createElement('button');
                refreshButton.id = 'refresh-status-btn';
                refreshButton.innerHTML = 'üîÑ Atualizar Status';
                refreshButton.style.background = '#667eea';
                refreshButton.style.color = 'white';
                refreshButton.style.border = 'none';
                refreshButton.style.padding = '8px 16px';
                refreshButton.style.borderRadius = '5px';
                refreshButton.style.cursor = 'pointer';
                refreshButton.style.marginTop = '10px';
                refreshButton.style.display = 'block';
                refreshButton.style.marginLeft = 'auto';
                refreshButton.style.marginRight = 'auto';
                
                container.querySelector('.alert').appendChild(document.createElement('br'));
                container.querySelector('.alert').appendChild(refreshButton);
            }
        }

        // Fun√ß√£o para gerar refer√™ncia √∫nica
        function generateExternalReference() {
            return 'ORDER-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        // Inicializar Payment Brick
        async function initializePaymentBrick() {
            try {
                showStatus('üîÑ Criando prefer√™ncia de pagamento...', 'info');

                // 1. Criar prefer√™ncia no backend
                const preference = await createPaymentPreference();
                
                if (!preference.success) {
                    throw new Error(preference.error || 'Erro ao criar prefer√™ncia');
                }

                showStatus('‚úÖ Prefer√™ncia criada! Carregando formas de pagamento...', 'success');

                // 2. Inicializar Mercado Pago SDK
                mp = new MercadoPago(preference.public_key, {
                    locale: 'pt-BR'
                });

                // 3. Criar Bricks Builder
                bricksBuilder = mp.bricks();

                // 4. Configurar Payment Brick
                const renderPaymentBrick = async () => {
                    if (paymentBrickController) {
                        paymentBrickController.unmount();
                    }

                    paymentBrickController = await bricksBuilder.create('payment', 'paymentBrick_container', {
                        initialization: {
                            amount: product.price,
                            preferenceId: preference.preference_id,
                        },
                        customization: {
                            paymentMethods: {
                                ticket: "all",
                                creditCard: "all",
                                debitCard: "all",
                                mercadoPago: "all"
                            },
                            visual: {
                                style: {
                                    theme: 'default'
                                }
                            }
                        },
                        callbacks: {
                            onReady: () => {
                                console.log('‚úÖ Payment Brick est√° pronto!');
                                showStatus('üí≥ Escolha sua forma de pagamento:', 'success');
                            },
                            onSubmit: async (formData) => {
                                console.log('üì§ Processando pagamento:', formData);
                                return await processPayment(formData, preference.preference_id);
                            },
                            onError: (error) => {
                                console.error('‚ùå Erro no Payment Brick:', error);
                                showStatus('‚ùå Erro no pagamento: ' + error.message, 'error');
                            }
                        }
                    });
                };

                await renderPaymentBrick();

            } catch (error) {
                console.error('‚ùå Erro ao inicializar Payment Brick:', error);
                showStatus('‚ùå Erro ao carregar pagamento: ' + error.message, 'error');
                
                // Mostrar bot√£o para tentar novamente
                document.getElementById('paymentBrick_container').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <p style="margin-bottom: 20px;">Erro ao carregar o pagamento</p>
                        <button onclick="initializePaymentBrick()" 
                                style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer;">
                            üîÑ Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }

        // Criar prefer√™ncia no backend
        async function createPaymentPreference() {
            try {
                const externalReference = generateExternalReference();
                
                const response = await fetch('/api/create-preference', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        items: [{
                            title: product.title,
                            description: product.description,
                            quantity: product.quantity,
                            unit_price: product.price
                        }],
                        external_reference: externalReference,
                        payer: {
                            email: 'test@example.com'
                        }
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Erro na requisi√ß√£o');
                }

                return {
                    success: true,
                    preference_id: data.preference_id,
                    public_key: data.public_key,
                    external_reference: externalReference
                };

            } catch (error) {
                console.error('‚ùå Erro ao criar prefer√™ncia:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        // Processar pagamento
        async function processPayment(formData, preferenceId) {
            try {
                showStatus('üîÑ Processando pagamento...', 'info');

                const response = await fetch('/api/process-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ...formData,
                        preference_id: preferenceId
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Erro no processamento');
                }

                // Tratar resultado baseado no status
                switch (result.status) {
                    case 'approved':
                        showStatus('üéâ Pagamento aprovado com sucesso!', 'success');
                        setTimeout(() => {
                            window.location.href = '/success?payment_id=' + result.id;
                        }, 2000);
                        break;
                        
                    case 'pending':
                        if (result.payment_method_id === 'pix') {
                            showStatus('üì± PIX gerado! Use o QR Code ou c√≥digo para pagar.', 'info');
                            // Mostrar QR Code se dispon√≠vel
                            if (result.point_of_interaction?.transaction_data?.qr_code_base64) {
                                showPixQRCode(result);
                                // Iniciar polling para verificar status do pagamento
                                startPaymentStatusPolling(result.id, result.external_reference);
                            }
                        } else {
                            showStatus('‚è≥ Pagamento pendente. Aguardando confirma√ß√£o.', 'info');
                            // Iniciar polling para verificar status do pagamento
                            startPaymentStatusPolling(result.id, result.external_reference);
                        }
                        break;
                        
                    case 'rejected':
                        showStatus('‚ùå Pagamento rejeitado: ' + result.status_detail, 'error');
                        break;
                        
                    default:
                        showStatus('‚ÑπÔ∏è Status: ' + result.status, 'info');
                }

                return result;

            } catch (error) {
                console.error('‚ùå Erro ao processar pagamento:', error);
                showStatus('‚ùå Erro no pagamento: ' + error.message, 'error');
                throw error;
            }
        }

        // Mostrar QR Code PIX
        function showPixQRCode(paymentResult) {
            const qrCodeBase64 = paymentResult.point_of_interaction?.transaction_data?.qr_code_base64;
            const qrCodeText = paymentResult.point_of_interaction?.transaction_data?.qr_code;
            
            if (qrCodeBase64) {
                const container = document.getElementById('statusContainer');
                container.innerHTML += `
                    <div class="alert alert-info" style="text-align: center;">
                        <h3>üí∞ PIX Gerado!</h3>
                        <p>Escaneie o QR Code ou copie o c√≥digo PIX:</p>
                        <img src="data:image/png;base64,${qrCodeBase64}" 
                             style="max-width: 200px; margin: 15px 0;" 
                             alt="QR Code PIX">
                        <br>
                        <button onclick="copyPixCode('${qrCodeText}')" 
                                style="background: #00a650; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 10px;">
                            üìã Copiar C√≥digo PIX
                        </button>
                        <div style="margin-top: 15px;">
                            <small>‚è∞ Pagamento expira em 30 minutos</small>
                        </div>
                    </div>
                `;
            }
        }

        // Copiar c√≥digo PIX
        function copyPixCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                showStatus('‚úÖ C√≥digo PIX copiado!', 'success');
            }).catch(() => {
                prompt('Copie o c√≥digo PIX:', code);
            });
        }
        
        // Fun√ß√£o para verificar o status do pagamento periodicamente
        function startPaymentStatusPolling(paymentId, externalReference) {
            console.log(`Iniciando polling para pagamento ID: ${paymentId}, Ref: ${externalReference}`);
            
            // Intervalo de verifica√ß√£o (em milissegundos) - a cada 5 segundos
            const pollingInterval = 5000;
            
            // Contador de tentativas
            let attempts = 0;
            const maxAttempts = 60; // 5 minutos (60 * 5 segundos)
            
            const checkPaymentStatus = async () => {
                attempts++;
                console.log(`Verificando status do pagamento (tentativa ${attempts})...`);
                
                try {
                    // Consultar o status do pagamento usando a rota de external_reference
                    const response = await fetch(`/payment/external/${externalReference}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Erro ao consultar status: ${response.status}`);
                    }
                    
                    const paymentData = await response.json();
                    console.log('Status do pagamento:', paymentData);
                    
                    // Verificar se o pagamento foi aprovado
                    if (paymentData.status === 'approved') {
                        showStatus('‚úÖ Pagamento aprovado! Obrigado pela compra.', 'success');
                        clearInterval(pollingId);
                        // Redirecionar para p√°gina de sucesso ou atualizar a UI
                        setTimeout(() => {
                            window.location.href = '/success.html?payment_id=' + paymentId;
                        }, 2000);
                        return;
                    }
                    
                    // Verificar se o pagamento foi rejeitado
                    if (paymentData.status === 'rejected') {
                        showStatus('‚ùå Pagamento rejeitado. Por favor, tente novamente.', 'error');
                        clearInterval(pollingId);
                        return;
                    }
                    
                    // Se atingiu o n√∫mero m√°ximo de tentativas
                    if (attempts >= maxAttempts) {
                        console.log('N√∫mero m√°ximo de tentativas atingido.');
                        clearInterval(pollingId);
                        showStatus('‚è±Ô∏è Tempo limite excedido. Verifique o status do seu pagamento mais tarde.', 'warning');
                    }
                    
                } catch (error) {
                    console.error('Erro ao verificar status do pagamento:', error);
                    // N√£o interromper o polling por erros tempor√°rios
                }
            };
            
            // Iniciar o intervalo de verifica√ß√£o
            const pollingId = setInterval(checkPaymentStatus, pollingInterval);
            
            // Primeira verifica√ß√£o imediata
            checkPaymentStatus();
            
            // Opcionalmente, atualizar o status do pagamento manualmente
            // O bot√£o √© criado dinamicamente na fun√ß√£o showStatus
            // Remover qualquer listener anterior
            document.querySelectorAll('#refresh-status-btn').forEach(btn => {
                btn.replaceWith(btn.cloneNode(true));
            });
            
            // Adicionar listener ao bot√£o atual ou futuro
            document.addEventListener('click', function(event) {
                if (event.target && event.target.id === 'refresh-status-btn') {
                    console.log('Atualizando status manualmente...');
                    checkPaymentStatus();
                }
            });
        }

        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inicializando Payment Brick...');
            initializePaymentBrick();
        });
    </script>
</body>
</html>
